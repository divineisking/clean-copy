{
  "version": 3,
  "sources": ["../src/engine/cleanText.js", "../src/policy/clipboardPolicy.js", "../src/clipboardAdapter.js", "../src/content.js"],
  "sourcesContent": ["\r\nconst INVISIBLE_FORMAT_CHARS =\r\n    /[\\u200B-\\u200D\\u2060\\uFEFF\\u034F]/g;\r\n\r\nconst BIDI_CONTROL_CHARS =\r\n    /[\\u202A-\\u202E\\u2066-\\u2069]/g;\r\n\r\nconst SOFT_LAYOUT_CHARS =\r\n    /[\\u00AD]/g;\r\n\r\nconst UNICODE_SPACES =\r\n    /[\\u00A0\\u1680\\u180E\\u2000-\\u200A\\u202F\\u205F\\u3000]/g;\r\n\r\nconst TAG_CHARS =\r\n    /[\\u{E0000}-\\u{E007F}]/gu;\r\n\r\nconst VARIATION_SELECTORS =\r\n    /[\\uFE00-\\uFE0F\\u{E0100}-\\u{E01EF}]/gu;\r\n\r\nfunction normalizeUnicode(text) {\r\n    return text.normalize(\"NFKC\");\r\n}\r\n\r\nfunction removeInvisibleChars(text) {\r\n    return text\r\n        .replace(INVISIBLE_FORMAT_CHARS, \"\")\r\n        .replace(BIDI_CONTROL_CHARS, \"\")\r\n        .replace(SOFT_LAYOUT_CHARS, \"\")\r\n        .replace(TAG_CHARS, \"\")\r\n        .replace(VARIATION_SELECTORS, \"\")\r\n        .replace(UNICODE_SPACES, \" \");\r\n}\r\n\r\nfunction normalizePunctuation(text) {\r\n    return text\r\n        .replace(/[\u201C\u201D]/g, '\"')\r\n        .replace(/[\u2018\u2019]/g, \"'\")\r\n        .replace(/\u2014/g, \" \")\r\n        .replace(/([\u2013\u2014-]){2,}/g, \" \");\r\n}\r\n\r\nfunction normalizeWhitespace(text) {\r\n    return text\r\n        .replace(/\\u00A0/g, \" \")\r\n        .replace(/\\r\\n/g, \"\\n\")\r\n        .replace(/\\s+/g, \" \")\r\n        .replace(/[ \\t]+$/gm, \"\")\r\n        .replace(/\\n{3,}/g, \"\\n\\n\")\r\n        .trim();\r\n}\r\n\r\n\r\nfunction cleanText(text) {\r\n    if (!text) return \"\";\r\n\r\n    return normalizeWhitespace(\r\n        normalizePunctuation(\r\n            removeInvisibleChars(\r\n                normalizeUnicode(text)\r\n            )\r\n        )\r\n    );\r\n}\r\n\r\n\r\nexport { cleanText };", "import { cleanText } from '../engine/cleanText.js';\r\n\r\n/**\r\n * PURE decision engine for clipboard operations\r\n */\r\nexport function clipboardPolicy({ operation, text }) {\r\n    const cleaned = cleanText(text ?? '');\r\n\r\n    if (operation === 'paste') {\r\n        return {\r\n            text: cleaned,\r\n            preventDefault: true\r\n        };\r\n    }\r\n\r\n    if (operation === 'copy') {\r\n        return {\r\n            text: cleaned,\r\n            preventDefault: true,\r\n            removeSelection: false\r\n        };\r\n    }\r\n\r\n    if (operation === 'cut') {\r\n        return {\r\n            text: cleaned,\r\n            preventDefault: true,\r\n            removeSelection: true\r\n        };\r\n    }\r\n\r\n    return {\r\n        text,\r\n        preventDefault: true\r\n    };\r\n}\r\n", "import { clipboardPolicy } from './policy/clipboardPolicy.js';\r\n\r\nfunction handleClipboardEvent(event) {\r\n\r\n    const isGoogleDocs = location.hostname.includes('docs.google.com');\r\n    if (isGoogleDocs) return; // Don't even try, let Docs handle it.\r\n\r\n    const { type, clipboardData } = event;\r\n    if (!clipboardData) return;\r\n\r\n    // --- PATH 1: PASTE (Inbound: Clipboard -> Screen) ---\r\n    // Inside handleClipboardEvent for PASTE\r\n    if (type === 'paste') {\r\n        const dirtyText = clipboardData.getData('text/plain');\r\n        if (!dirtyText) return;\r\n\r\n        const decision = clipboardPolicy({ operation: type, text: dirtyText });\r\n\r\n        if (decision.preventDefault) {\r\n            event.preventDefault();\r\n            event.stopImmediatePropagation(); // <--- CRITICAL for Gmail\r\n\r\n            // Attempt 1: Standard insert\r\n            let success = document.execCommand(\"insertText\", false, decision.text);\r\n\r\n            // Attempt 2: Fallback for some Rich Text Editors (Force plain text insert)\r\n            if (!success) {\r\n                // This is a more aggressive insertion method\r\n                const selection = window.getSelection();\r\n                if (selection && selection.rangeCount) {\r\n                    const range = selection.getRangeAt(0);\r\n                    range.deleteContents(); // Clear selected text if any\r\n                    range.insertNode(document.createTextNode(decision.text));\r\n\r\n                    // Move cursor to end of inserted text\r\n                    range.collapse(false);\r\n                    selection.removeAllRanges();\r\n                    selection.addRange(range);\r\n                    success = true;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // --- PATH 2: COPY / CUT (Outbound: Screen -> Clipboard) ---\r\n    // For these, we DO look at what the user has selected on screen.\r\n\r\n    // Inside handleClipboardEvent for COPY/CUT\r\n    if (type === 'copy' || type === 'cut') {\r\n        const selection = window.getSelection();\r\n        const selectionText = selection?.toString() ?? \"\";\r\n\r\n        if (!selectionText.trim()) return; // Docs fails here (returns empty)\r\n\r\n        const decision = clipboardPolicy({ operation: type, text: selectionText });\r\n\r\n        if (decision.preventDefault) {\r\n            event.preventDefault();\r\n            event.stopImmediatePropagation(); // <--- ADD THIS. Kills other listeners.\r\n\r\n            clipboardData.clearData();\r\n            clipboardData.setData(\"text/plain\", decision.text);\r\n\r\n            // Use 'text/html' too if you want to strip styles but keep the slot active\r\n            // clipboardData.setData(\"text/html\", decision.text); \r\n\r\n            if (decision.removeSelection && selection.rangeCount) {\r\n                selection.deleteFromDocument();\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nexport function attachClipboardCleaner() {\r\n    document.addEventListener(\"copy\", handleClipboardEvent, true);\r\n    document.addEventListener(\"cut\", handleClipboardEvent, true);\r\n    document.addEventListener(\"paste\", handleClipboardEvent, true);\r\n}", "// content.js\r\nimport { attachClipboardCleaner } from './clipboardAdapter.js';\r\n\r\nattachClipboardCleaner();\r\n"],
  "mappings": "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",
  "names": []
}
